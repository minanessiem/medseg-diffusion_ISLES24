# Multi-task loss: MSE + Dice + BCE
# Combines diffusion noise prediction with direct segmentation supervision
#
# Reference: DiffSwinTr (MICCAI 2023)
# Expected improvement: +1-3% Dice score vs. pure MSE baseline

# Primary diffusion loss type (passed to GaussianDiffusion)
loss_type: MSE

# Auxiliary segmentation losses
# total_loss = diffusion_weight * MSE + dice_weight * Dice + bce_weight * BCE
auxiliary_losses:
  enabled: true
  diffusion_weight: 1.0
  
  # Dice loss - optimizes segmentation overlap metric
  dice:
    enabled: true
    weight: 0.1
    smooth: 1.0e-8  # Matches DiceNativeCoefficient for metric alignment
    apply_sigmoid: false  # pred_x0 already in [0, 1]
  
  # BCE loss - pixel-wise boundary refinement
  bce:
    enabled: true
    weight: 0.1
    pos_weight: null  # null = balanced; set to (neg/pos) for imbalanced data
    apply_sigmoid: false
  
  # Warmup: auxiliary losses start after this many steps
  warmup_steps: 20000  # 0 = immediate, 1000-5000 = conservative

# Example configurations for different scenarios:
#
# 1. Emphasize Dice (global overlap):
#    dice.weight: 0.7, bce.weight: 0.3
#
# 2. Emphasize BCE (boundary refinement):
#    dice.weight: 0.3, bce.weight: 0.7
#
# 3. Imbalanced dataset (5% foreground):
#    bce.pos_weight: 19.0  # (95/5 = 19)
#
# 4. Very unstable training:
#    dice.smooth: 1.0  # More relaxed smoothing
#    warmup_steps: 5000  # Wait for diffusion to stabilize
#
# 5. Pure Dice (no BCE):
#    dice.weight: 1.0, bce.enabled: false
#
# 6. Disable auxiliary losses (pure MSE):
#    enabled: false

