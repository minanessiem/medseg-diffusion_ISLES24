# Training-specific parameters (split from default.yaml)
# num_epochs: 50  # Deprecated: Use max_steps for step-based training instead

max_steps: 100000  # Maximum training steps


ema_rate_precision: 4  # Decimal places for EMA rate in filename
ema_rate: "0.9999"  # Comma-separated for multiple, e.g. "0.999,0.9999"

# Gradient techniques
gradient:
  clip_norm: 1.0  # Max gradient norm (null = disabled)
  clip_value: null  # Alternative: clip by value
  accumulation_steps: null  # Gradient accumulation: null or 1 = no accumulation (one optimizer update per forward pass)
                            # N > 1 = accumulate gradients over N micro-batches before optimizer update (e.g., 4 → 4 micro-batches per update)
                            # Effective batch size = physical_batch_size * N
                            # Example: batch_size=4, accumulation_steps=4 → effective_batch_size=16
                            # Use to simulate larger batch sizes without GPU OOM
                            # Note: clip_norm applies to accumulated gradients (correct behavior matching large-batch training)
                            # Note: All intervals (validation, checkpointing, logging) measured in optimizer updates, not forward passes

# Interval-based checkpoints (for training resumption)
# Saves model + optimizer + training state at fixed step intervals for fault recovery
checkpoint_interval:
  enabled: true
  save_interval: 10000
  keep_last_n: 3  # Keep only last 3 interval checkpoints (null = keep all)
  model_template: 'models/checkpoint/diffusion_chkpt_step_{:06d}.pth'
  opt_template: 'models/checkpoint/opt_chkpt_step_{:06d}.pth'
  state_template: 'models/checkpoint/training_state_step_{:06d}.pth'  # Complete training state (EMA, scheduler, metrics)

# Metric-based best model checkpoints (for inference)
# Saves model + EMA when validation metric improves
checkpoint_best:
  enabled: true
  metric_name: "dice_2d_fg"  # Must match validation metric key (without "val_" prefix)
  metric_mode: "max"  # "max" (higher is better) or "min" (lower is better)
  keep_last_n: 3  # Keep only top 3 best models by metric value (null = keep all)
  save_metrics_csv: true  # Save CSV file with all validation metrics
  model_template: 'models/best/best_model_step_{step:06d}_{metric_name}_{metric_value:.4f}.pth'
  ema_template: 'models/best/best_model_step_{step:06d}_{metric_name}_{metric_value:.4f}_ema_{rate}.pth'
  metrics_template: 'models/best/best_model_step_{step:06d}_{metric_name}_{metric_value:.4f}_metrics.csv'
